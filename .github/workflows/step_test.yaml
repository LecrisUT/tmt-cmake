on:
  workflow_call:
    inputs:
      mask-experimental:
        type: boolean
        default: true
        description: Always report experimental test as successful
    secrets:
      TESTING_FARM_API_TOKEN:
        required: false
        description: API token for testing farm

permissions:
  contents: read

jobs:
  checks:
    name: >
      üêç ${{ matrix.python-version }}
      ${{ matrix.tmt-version && format('üå≥ {0}', matrix.tmt-version) || '' }}
      ${{ matrix.experimental && '[üß™ Experimental]' || '' }}
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental || false }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
        include:
          - python-version: "3.x"
            tmt-version: "main"
            experimental: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install package
        run: pip install -e .[test]
      - name: Install tmt ${{ matrix.tmt-version }}
        run: pip install tmt@git+https://github.com/teemtee/tmt@${{ matrix.tmt-version }}
        if: matrix.tmt-version
      - name: Test package
        run: pytest
        continue-on-error: ${{ matrix.experimental && inputs.mask-experimental}}

  testing-farm:
    runs-on: ubuntu-latest
    env:
      TESTING_FARM_API_TOKEN: ${{ secrets.TESTING_FARM_API_TOKEN }}
    permissions:
      contents: read
      statuses: write
      pull-requests: write
    steps:
      - uses: sclorg/testing-farm-as-github-action@v2
        with:
          api_key: ${{ secrets.TESTING_FARM_API_TOKEN }}
          git_url: ${{ github.server_url }}/${{ github.repository }}
          git_ref: ${{ github.ref }}
          create_issue_comment: true
          update_pull_request_status: true
        # Cannot use secrets in the if conditional, using env variable instead
        if: ${{ env.TESTING_FARM_API_TOKEN != '' }}

  tmt-action:
    # TODO: Move main tests to use the GH action
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental || false }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - uses: LecrisUT/tmt-actions/setup-tmt@main
      - uses: LecrisUT/tmt-actions/run-tmt@main
        with:
          report-artifact: JUnit-tmt

  report:
    name: Report JUnit
    needs: [ tmt-action ]
    permissions:
      contents: read
      checks: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: "*/report.xml"
          large_files: true
          report_individual_runs: true
          report_suite_logs: any
    if: always()
